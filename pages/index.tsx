import type { NextPage } from 'next'
import axios from 'axios';
import Head from 'next/head'
import Organization from '../modules/home/components/organization'
import {useState, useEffect} from 'react'
import styles from '../styles/Home.module.css'

const axiosGitHubGraphQL = axios.create({
  baseURL: 'https://api.github.com/graphql',
  headers: {
    Authorization: `bearer ${
      process.env.NEXT_PUBLIC_GITHUB_PERSONAL_ACCESS_TOKEN
    }`,
  },
});
const TITLE = 'React GraphQL GitHub Client';

const GET_ISSUES_OF_REPOSITORY = `
  query ($organization: String!, $repository: String!, $cursor: String) {
    organization(login: $organization) {
      name
      url
      repository(name: $repository) {
        name
        url
        issues(first: 5, after: $cursor, states: [OPEN]) {
          edges {
            node {
              id
              title
              url
              reactions(first: 3) {
                edges {
                  node {
                    id
                    content
                  }
                }
                totalCount
                pageInfo {
                  endCursor
                  hasNextPage
                }
              }
            }
          }
          totalCount
          pageInfo {
            endCursor
            hasNextPage
          }
        }
      }
    }
  }
`;

interface initialErrorProps {
  message: string;
}

const Home: NextPage = () => {
  const [path, setPath] = useState('the-road-to-learn-react/the-road-to-learn-react');
  const [organization, setOrganization] = useState();
  const [errors, setErrors] = useState<initialErrorProps[] | undefined>();

  const getIssuesOfRepository = (cursor?: string) => {
    const [org, repo] = path.split('/');
    axiosGitHubGraphQL
      .post('', {
        query: GET_ISSUES_OF_REPOSITORY,
        variables: {
          organization: org,
          repository: repo,
          cursor
        },
      })
      .then((queryResult) => resolveIssuesQuery(queryResult, cursor));
  }

  const resolveIssuesQuery = (queryResult, cursor?: string) => {
    const { data, errors } = queryResult.data;

    if (!cursor) {
      setOrganization(data.organization);
    } else if (organization) {
      const { edges: oldIssues } = organization.repository.issues;
      const { edges: newIssues } = data.organization.repository.issues;
      setOrganization({
        ...data.organization,
        repository: {
          ...data.organization.repository,
          issues: {
            ...data.organization.repository.issues,
            edges: [...oldIssues, ...newIssues],
          },
        },
      });
    }
    setErrors(errors);
  }

  const onFetchMoreIssues = () => {
    if (organization) {
      const {endCursor} = organization.repository.issues.pageInfo;
      getIssuesOfRepository(endCursor);
    }
  }

  useEffect(() => {
   getIssuesOfRepository();
  }, []);

  const inputUpdated = (e: React.ChangeEvent<HTMLInputElement>) => setPath(e.currentTarget.value);
  const submitForm = (e: React.FormEvent) => {
    e.preventDefault();
    getIssuesOfRepository();
  };
  
  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
      </Head>

      <main>
        <h1>{TITLE}</h1>
        <form onSubmit={submitForm}>
          <label htmlFor="url">
            Show open issues for https://github.com/
          </label>
          <input
            id="url"
            type="text"
            value={path}
            onChange={inputUpdated}
            autoFocus
          />
          <button type="submit">Submit</button>
        </form>

        <hr />
        { errors ?
          <p>
            <strong>Something went wrong:</strong>
            {errors.map(error => error.message).join(' ')}
          </p>
        : (organization
          ? <Organization organization={organization} onFetchMoreIssues={onFetchMoreIssues} />
          : <p>No information yet ...</p>
        )
      } 
      </main>
    </div>
  )
}

export default Home
